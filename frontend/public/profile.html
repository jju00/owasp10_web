<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>BlackCat Security | Profile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="BlackCat Security í”„ë¡œí•„" />
  <link rel="stylesheet" href="/frontend/public/assets/css/style.css" />
  <link rel="stylesheet" href="/frontend/public/assets/css/board.css" />
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="brand" href="/#top" aria-label="BlackCat Security">
        <img src="/frontend/public/assets/img/dark-logo.png" alt="" />
        <span class="brand-text">BlackCat Security</span>
      </a>

      <nav class="nav" aria-label="ì£¼ìš” ë©”ë‰´">
        <button class="nav-toggle" aria-expanded="false" aria-controls="navMenu">ë©”ë‰´</button>
        <ul id="navMenu" class="nav-menu">
          <!-- ë“œë¡­ë‹¤ìš´: HOME -->
          <li class="has-sub">
            <a class="toplink" href="/"> 
              HOME<span class="arrow"> </span></a>
          </li>

          <!-- ë“œë¡­ë‹¤ìš´: ABOUT -->
          <li class="has-sub">
            <a class="toplink" href="/#about">
              ABOUT <span class="arrow"> </span></a>
          </li>

          <!-- ë“œë¡­ë‹¤ìš´: ACTIVIty -->
          <li class="has-sub">
            <a class="toplink" href="/#activities">
              ACTIVITY <span class="arrow">â–¼</span></a>
            <ul class="submenu">
              <li><a href="/#activities">Study</a></li>
              <li><a href="/#activities">Conference</a></li>
              <li><a href="/#activities">CTF</a></li>
              <li><a href="/#activities">Project</a></li>
            </ul>
          </li>

          <!-- ë“œë¡­ë‹¤ìš´: BOARD -->
          <li class="has-sub">
            <a class="toplink" href="/board">
              BOARD <span class="arrow"></span></a>
          </li>

          <!-- ë“œë¡­ë‹¤ìš´: login -->
          <li class="has-sub">
            <a class="toplink" id="loginMenu" href="/login">
              LOGIN <span class="arrow">â–¼</span></a>
            <ul class="submenu">
              <li><a href="/login">Login</a></li>
              <li><a href="#signup">Sign Up</a></li>
              <li><a href="/account/recover.html">Forgotten ID / PW</a></li>
            </ul>
          </li>
        </ul>
      </nav>

      <!-- í—¤ë” ì•„ì´ì½˜ -->
      <div class="header-actions" role="group" aria-label="ì‚¬ìš©ì/ê²€ìƒ‰/ì–¸ì–´">
        <a class="icon-btn" id="personBtn" href="/login" aria-label="ë¡œê·¸ì¸">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/></svg>
        </a>
        <span class="vdiv" aria-hidden="true"></span>
        <button class="icon-btn" type="button" aria-label="ê²€ìƒ‰">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M21 20.29 16.65 16a8 8 0 1 0-1.41 1.41L20.29 21 21 20.29ZM4 10a6 6 0 1 1 6 6 6 6 0 0 1-6-6Z"/></svg>
        </button>
      </div>
    </div>
  </header>


  <section class="board-index container">
    <h1>ğŸ‘¤ Profile</h1>
    <p><strong>ID:</strong> <span id="username">Loading...</span></p>
    <p><strong>User ID:</strong> <span id="userId">Loading...</span></p>
    <p><strong>Role:</strong> <span id="userRole">Loading...</span></p>
    <p><strong>Sign up Date:</strong> 2025.05.06.</p>
    <a href="">Community Guideline</a>


    <h2>ğŸ“ Written Post</h2>

      <!-- ëª©ë¡ í…Œì´ë¸” -->
      <div class="board-main">
        <div class="board-table-wrap" role="region" aria-label="ê²Œì‹œê¸€ ëª©ë¡" tabindex="0">
          <table class="board-list" id="table">
            <thead>
              <tr>
                <th scope="col">Board</th>
                <th scope="col">Title</th>
                <th scope="col">Author</th>
                <th scope="col">Date</th>
              </tr>
            </thead>
            <tbody id="my-posts"><!-- JS ë Œë” --></tbody>
          </table>
        </div>
      </div>
    <p>Version: 1.0.11.7</p>
  </section>

  <script src="/frontend/public/assets/js/auth.js"></script>
  <script>
    (function() {
      // ë¡œê·¸ì¸ ì²´í¬
      const token = (window.getToken && window.getToken()) || null;
      if (!token) {
        alert('Login is required.');
        location.href = '/login?returnTo=' + encodeURIComponent(location.pathname);
        return;
      }

      const headers = { 
        Authorization: token.startsWith('Bearer ') ? token : `Bearer ${token}` 
      };

      // URL ê²½ë¡œì—ì„œ í”„ë¡œí•„ ID ì¶”ì¶œ (ì˜ˆ: /profile/2 â†’ 2, /profile/me â†’ me)
      const pathParts = location.pathname.split('/');
      const profileId = pathParts[pathParts.length - 1] || 'me';

      // /profile/me ì ‘ê·¼ ì‹œ ìë™ìœ¼ë¡œ ì‹¤ì œ userIdë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      if (profileId === 'me') {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const myUserId = payload.id;
        location.replace('/profile/' + myUserId);
        return;
      }

      // API ì—”ë“œí¬ì¸íŠ¸ (í•­ìƒ ìˆ«ì IDë¡œë§Œ í˜¸ì¶œ)
      const apiUrl = `/api/profile/${encodeURIComponent(profileId)}`;  // IDOR ì·¨ì•½ì 

      // í”„ë¡œí•„ ì •ë³´ ì¡°íšŒ
      fetch(apiUrl, { headers, credentials: 'include' })
        .then(async (res) => {
          if (res.status === 401) {
            alert('Token Expired.');
            location.href = '/login?returnTo=' + encodeURIComponent(location.pathname);
            return null;
          }
          if (res.status === 403) {
            alert('You do not have permission to access this page. (Admin profiles cannot be viewed.)');
            return null;
          }
          if (res.status === 404) {
            alert('User not found.');
            return null;
          }
          if (!res.ok) throw new Error('fail ' + res.status);
          return res.json();
        })
        .then(profile => {
          if (!profile) return;

          // í”„ë¡œí•„ ì •ë³´ í‘œì‹œ
          document.getElementById('username').textContent = profile.username || 'ì•Œ ìˆ˜ ì—†ìŒ';
          document.getElementById('userId').textContent = profile.id || 'ì•Œ ìˆ˜ ì—†ìŒ';
          document.getElementById('userRole').textContent = profile.role || 'ì•Œ ìˆ˜ ì—†ìŒ';

          // ê²Œì‹œê¸€ ëª©ë¡ ë Œë”ë§ (ë”ë¯¸ ë°ì´í„° - ì‹¤ì œë¡œëŠ” APIë¡œ ë°›ì•„ì™€ì•¼ í•¨)
          const PAGES = {
          1: [
            {pageId:1, cat:'NOTICE',   title:'[NOTICE] BlackCat Monthly Seminar Announcement',   author:'admin',   date:'2025-04-02'},
            {pageId:2, cat:'EVENT', title:'Club Graduation Ceremony',    author:'bob',     date:'2025-04-02'},
            {pageId:3, cat:'EVENT', title:'Club Study Session',                 author:'bob',     date:'2025-04-02'},
            {pageId:4, cat:'PROMOTION', title:'Recruiting Members for an Offline Security Study Group',       author:'charlie', date:'2025-04-02'},
            {pageId:5, cat:'SECRET', title:'My Catâ€™s Photo',                 author:'Anonymous',   date:'2025-04-02'},
            {pageId:6, cat:'NOTICE',   title:'[NOTICE] BlackCat End-of-Semester Gathering',      author:'admin',   date:'2025-04-01'},  // â† 2pì—ì„œ ì´ì‚¬
            {pageId:7, cat:'SECRET', title:'TEST',                       author:'Anonymous',      date:'2025-04-01'},  // â† 2pì—ì„œ ì´ì‚¬
          ],
          2: [
            {pageId:8,  cat:'EVENT', title:'End-of-Semester General Meeting',  author:'alice',     date:'2025-04-01'},
            {pageId:9,  cat:'PROMOTION', title:'Looking for Project Members',              author:'alice',     date:'2025-04-01'},
            {pageId:10, cat:'SECRET', title:'How to Upload a Cat Photo',          author:'Anonymous',      date:'2025-04-01'},
          ],
        };

        const CAT_CLASS = {
          'NOTICE': 'cat-noti',
          'EVENT': 'cat-free',
          'SECRET': 'cat-secret',
          'PROMOTION': 'cat-promo',
        };

          const tbody = document.getElementById('my-posts');
          tbody.innerHTML = '';

          const allPosts = Object.values(PAGES).flat();
          const myPosts = allPosts.filter(post => post.author === profile.username);

          if (myPosts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">You havenâ€™t written any posts.</td></tr>';
          } else {
            myPosts.forEach(post => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><span class="cat ${CAT_CLASS[post.cat] || ''}">${post.cat}</span></td>
                <td class="tt"><a href="/post/${post.pageId}">${post.title}</a></td>
                <td class="author">${post.author}</td>
                <td>${post.date.slice(5)}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        })
        .catch(err => {
          console.error(err);
          alert('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    })();
  </script>

    <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ GNB ê°±ì‹  -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const loginMenu = document.getElementById('loginMenu');          // <a id="loginMenu">LOGIN â–¼</a>
    const personBtn = document.getElementById('personBtn');
    const loginLi   = loginMenu?.closest('li.has-sub');              // <li class="has-sub"> ... </li>
    const submenu   = loginLi?.querySelector('.submenu');            // ë“œë¡­ë‹¤ìš´ UL
    const arrow     = loginMenu?.querySelector('.arrow');            // â–¼ ì•„ì´ì½˜ span

    const hasToken = !!(window.getToken && window.getToken());

    if (hasToken) {
      // 1) ìƒë‹¨ í…ìŠ¤íŠ¸/ë™ì‘ì„ LOGOUTìœ¼ë¡œ ì „í™˜
      loginMenu.textContent = 'LOGOUT';
      loginMenu.href = '#';
      loginMenu.addEventListener('click', (e) => {
        e.preventDefault();
        clearToken();
        alert('You have been logged out.');
        location.href = '/';
      }, { once: true });

      // 2) ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì œê±° (ë¡œê·¸ì¸/íšŒì›ê°€ì…/ì•„ì´ë””ì°¾ê¸° ìˆ¨ê¹€)
      if (submenu) submenu.remove();
      // ë“œë¡­ë‹¤ìš´ ì¼€ëŸ¿/ìŠ¤íƒ€ì¼ ì œê±°
      arrow?.remove();
      loginLi?.classList.remove('has-sub');

      // 3) ì‚¬ëŒ ì•„ì´ì½˜ì€ ë§ˆì´í˜ì´ì§€ë¡œ
      personBtn?.setAttribute('href','/profile/me');
    } else {
      // ë¹„ë¡œê·¸ì¸: ê¸°ë³¸ ë§í¬ ìœ ì§€
      loginMenu?.setAttribute('href','/login');
      personBtn?.setAttribute('href','/login');
    }
  });
  </script>

     <!-- í‘¸í„° -->
  <footer class="site-footer">
    <div class="container footer-inner">
      <div><strong>BlackCat Security</strong><br/>security@blackcat.security</div>
    </div>
    <p class="copy">Â© 2025 BlackCat Security. All rights reserved.</p>
  </footer>
</body>
</html>

