<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>BlackCat Security | Board</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="BlackCat Security 게시판" />
  <link rel="stylesheet" href="/frontend/public/assets/css/style.css" />
  <link rel="stylesheet" href="/frontend/public/assets/css/board.css" />
</head>

<body id="top">
  <!-- 헤더 -->
  <header class="site-header">
    <div class="header-inner">
      <a class="brand" href="/#top" aria-label="BlackCat Security">
        <img src="/frontend/public/assets/img/dark-logo.png" alt="" />
        <span class="brand-text">BlackCat Security</span>
      </a>

      <nav class="nav" aria-label="주요 메뉴">
        <button class="nav-toggle" aria-expanded="false" aria-controls="navMenu">menu</button>
        <ul id="navMenu" class="nav-menu">
          <!-- 드롭다운: HOME -->
          <li class="has-sub">
            <a class="toplink" href="/"> 
              HOME<span class="arrow"> </span></a>
          </li>

          <!-- 드롭다운: ABOUT -->
          <li class="has-sub">
            <a class="toplink" href="/#about">
              ABOUT <span class="arrow"> </span></a>
          </li>

          <!-- 드롭다운: ACTIVIty -->
          <li class="has-sub">
            <a class="toplink" href="/#activities">
              ACTIVITY <span class="arrow">▼</span></a>
            <ul class="submenu">
              <li><a href="/#activities">Study</a></li>
              <li><a href="/#activities">Conference</a></li>
              <li><a href="/#activities">CTF</a></li>
              <li><a href="/#activities">Project</a></li>
            </ul>
          </li>

          <!-- 드롭다운: BOARD -->
          <li class="has-sub">
            <a class="toplink" href="/board">
              BOARD <span class="arrow"></span></a>
          </li>

          <!-- 드롭다운: login -->
          <li class="has-sub">
            <a class="toplink" id="loginMenu" href="/login">
              LOGIN <span class="arrow">▼</span></a>
            <ul class="submenu">
              <li><a href="/login">Login</a></li>
              <li><a href="#signup">Sign Up</a></li>
              <li><a href="/account/recover.html">Forgotten ID / PW</a></li>
            </ul>
          </li>
        </ul>
      </nav>

      <!-- 헤더 아이콘 -->
      <div class="header-actions" role="group" aria-label="사용자/검색/언어">
        <a class="icon-btn" id="personBtn" href="/login" aria-label="로그인">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/></svg>
        </a>
        <span class="vdiv" aria-hidden="true"></span>
        <button class="icon-btn" type="button" aria-label="검색">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M21 20.29 16.65 16a8 8 0 1 0-1.41 1.41L20.29 21 21 20.29ZM4 10a6 6 0 1 1 6 6 6 6 0 0 1-6-6Z"/></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- 메인 보드 -->
  <section class="board-index container">
    <div class="board-shell">
      <!-- 왼쪽 사이드바 -->
      <aside class="board-side" aria-label="게시판 카테고리">
        <h3 class="side-title">Board</h3>
        <nav class="side-nav">
          <button class="side-item is-active" data-cat="all">ALL</button>
          <button class="side-item" data-cat="NOTICE">NOTICE</button>
          <button class="side-item" data-cat="EVENT">EVENT</button>
          <button class="side-item" data-cat="SECRET">SECRET</button>
          <button class="side-item" data-cat="PROMOTION">PROMOTION</button>
        </nav>
      </aside>

      <!-- 메인 -->
      <div class="board-main">
        <!-- 검색 -->
        <form class="board-search" id="searchForm" role="search" aria-label="게시글 검색">
          <span class="search-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M21 20.29 16.65 16a8 8 0 1 0-1.41 1.41L20.29 21 21 20.29ZM4 10a6 6 0 1 1 6 6 6 6 0 0 1-6-6Z"/></svg>
          </span>
          <input id="q" class="search-input" type="search" name="q" placeholder="Search" aria-label="검색어" />
        </form>

        <!-- 목록 테이블 -->
        <div class="board-table-wrap" role="region" aria-label="게시글 목록" tabindex="0">
          <table class="board-list" id="table">
            <colgroup>
              <col style="width:160px" />
              <col />
              <col style="width:120px" />
              <col style="width:110px" />
            </colgroup>
            <thead>
              <tr>
                <th scope="col">Board</th>
                <th scope="col">Title</th>
                <th scope="col">Author</th>
                <th scope="col">Date</th>
              </tr>
            </thead>
            <tbody id="tbody"><!-- JS 렌더 --></tbody>
          </table>
        </div>

        <!-- 페이지네이션 -->
        <nav class="pager" id="pager" aria-label="페이지 이동">
          <button class="page" id="first" aria-label="첫 페이지">«</button>
          <button class="page" id="prev"  aria-label="이전 페이지">‹</button>
          <button class="page" data-p="1">1</button>
          <button class="page" data-p="2">2</button>
          <button class="page" id="next"  aria-label="다음 페이지">›</button>
          <button class="page" id="last"  aria-label="마지막 페이지">»</button>
        </nav>
      </div>
    </div>
  </section>

  <!-- 푸터 -->
  <footer class="site-footer">
    <div class="container footer-inner">
      <div><strong>BlackCat Security</strong><br/>security@blackcat.security</div>
    </div>
    <p class="copy">© 2025 BlackCat Security. All rights reserved.</p>
  </footer>
 
  <!-- JS -->
  <script>
  function parseJwt(token) {
    try {
      return JSON.parse(atob(token.split('.')[1]));
    } catch (e) {
      return null;
    }
  }

  function getCurrentUsername() {
    const token = window.getToken && window.getToken();
    if (!token) return null;
    const payload = parseJwt(token);
    return payload?.username || null;
  }
  </script>
  <script>
  // 모바일 네비 토글(공통)
  const navToggle = document.querySelector('.nav-toggle');
  const navMenu = document.getElementById('navMenu');
  navToggle?.addEventListener('click', () => {
    const open = navMenu.classList.toggle('open');
    navToggle.setAttribute('aria-expanded', String(open));
  });

  (() => {
    // ===== 데이터: 1페이지 7개 / 2페이지 1개 =====
    const PAGES = {
      1: [
        {pageId:1, cat:'NOTICE',   title:'[NOTICE] BlackCat Monthly Seminar Announcement',   author:'bob',   date:'2025-04-02'},
        {pageId:2, cat:'EVENT', title:'Club Graduation Ceremony',    author:'diana',     date:'2025-04-02'},
        {pageId:3, cat:'EVENT', title:'Club Study Session',                 author:'diana',     date:'2025-04-02'},
        {pageId:4, cat:'PROMOTION', title:'Recruiting Members for an Offline Security Study Group',       author:'charlie', date:'2025-04-02'},
        {pageId:5, cat:'NOTICE',   title:'[NOTICE] BlackCat End-of-Semester Gathering',      author:'bob',   date:'2025-04-01'},  // ← 2p에서 이사
        {pageId:6, cat:'SECRET', title:'TEST',                       author:'bob',      date:'2025-04-01'},  // ← 2p에서 이사
        {pageId:7,  cat:'EVENT', title:'End-of-Semester General Meeting',  author:'diana',     date:'2025-04-01'}      
        ],
      2: [  
        {pageId:8,  cat:'PROMOTION', title:'Looking for Project Members',              author:'alice',     date:'2025-04-01'}
      ],
    };

    const CAT_CLASS = {
      'NOTICE': 'cat-noti',
      'EVENT': 'cat-free',
      'SECRET': 'cat-secret',
      'PROMOTION': 'cat-promo',
    };

    // page 파라미터
    const PAGE_PARAM = 'p';

    const tbody  = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    const pager  = document.getElementById('pager');
    const sideBtns = document.querySelectorAll('.side-item');

    const params = new URLSearchParams(location.search);
    let page     = Number(params.get(PAGE_PARAM) || 1);   // ← 기존 'page' → 'p'
    let q        = params.get('q') || '';
    let catFilter= params.get('cat') || 'all';

    const ALL = [...PAGES[1], ...PAGES[2]];

    function fmtDate(s){ const m=/(\d{4})-(\d{2})-(\d{2})/.exec(s); return m?`${m[2]}-${m[3]}`:s; }

    function render(){
      let rows = [];
      const currentUsername = getCurrentUsername();

      if (!q.trim() && catFilter === 'all') {
        rows = PAGES[page] || [];
        pager.style.display = '';
      } else {
        const term = q.trim().toLowerCase();
        rows = ALL.filter(r => {
          const okCat = (catFilter==='all') || (r.cat===catFilter);
          const okQ   = term ? (r.title.toLowerCase().includes(term) || r.cat.toLowerCase().includes(term) || r.author.toLowerCase().includes(term)) : true;
          return okCat && okQ;
        });
        pager.style.display = 'none';
      }

      // SECRET + 다른 작성자 → /post/0으로 리디렉션 처리
      tbody.innerHTML = rows.map(r => {
        const isPrivate = r.cat === 'SECRET' && r.author !== currentUsername;
        const link = isPrivate ? '/post/0' : `/post/${r.pageId}`;
        return `
          <tr>
            <td><span class="cat ${CAT_CLASS[r.cat]||'cat-free'}">${r.cat}</span></td>
            <td class="tt"><a href="${link}">${r.title}</a></td>
            <td class="author">${r.author}</td>
            <td><time>${fmtDate(r.date)}</time></td>
          </tr>
        `;
      }).join('');

      if (!q.trim() && catFilter==='all') {
        document.querySelectorAll('.pager .page[data-p]').forEach(b=>{
          b.classList.toggle('is-current', Number(b.dataset.p)===page);
        });
        const atFirst = page===1, atLast = page===2;
        document.getElementById('first').disabled = atFirst;
        document.getElementById('prev').disabled  = atFirst;
        document.getElementById('next').disabled  = atLast;
        document.getElementById('last').disabled  = atLast;
      }

      sideBtns.forEach(b=>{
        b.classList.toggle('is-active', b.dataset.cat===catFilter || (catFilter==='all'&&b.dataset.cat==='all'));
      });
    }

    // 페이지 버튼
    document.querySelectorAll('.pager .page[data-p]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        page = Number(btn.dataset.p);
        params.set(PAGE_PARAM, String(page));
        params.delete('q'); params.set('cat','all');
        history.replaceState(null,'',`?${params.toString()}`);
        q=''; qInput.value=''; catFilter='all';
        render();
      });
    });
    document.getElementById('first').addEventListener('click', ()=>go(1));
    document.getElementById('prev').addEventListener('click', ()=>go(Math.max(1,page-1)));
    document.getElementById('next').addEventListener('click', ()=>go(Math.min(2,page+1)));
    document.getElementById('last').addEventListener('click', ()=>go(2));
    function go(p){
      page = p; params.set(PAGE_PARAM, String(page));
      params.delete('q'); params.set('cat','all');
      history.replaceState(null,'',`?${params.toString()}`);
      q=''; qInput.value=''; catFilter='all'; render();
    }

    // 검색
    qInput.value = q;
    document.getElementById('searchForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      q = qInput.value || '';
      if (q) params.set('q', q); else params.delete('q');
      params.delete(PAGE_PARAM); params.set('cat','all');
      history.replaceState(null,'',`?${params.toString()}`);
      render();
    });

    // 사이드바 필터
    sideBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        catFilter = btn.dataset.cat;
        params.set('cat', catFilter);
        params.delete(PAGE_PARAM); // 필터 모드에선 페이지 의미 없음
        params.delete('q'); q=''; qInput.value='';
        history.replaceState(null,'',`?${params.toString()}`);
        render();
      });
    });

    // 초기 보정 & 렌더
    if (page<1 || page>2) { page=1; params.set(PAGE_PARAM,'1'); history.replaceState(null,'',`?${params.toString()}`); }
    render();
  })();
  </script>

  <!-- 로그인 상태에 따라 GNB 갱신 -->
  <script src="/frontend/public/assets/js/auth.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const loginMenu = document.getElementById('loginMenu');          // <a id="loginMenu">LOGIN ▼</a>
    const personBtn = document.getElementById('personBtn');
    const loginLi   = loginMenu?.closest('li.has-sub');              // <li class="has-sub"> ... </li>
    const submenu   = loginLi?.querySelector('.submenu');            // 드롭다운 UL
    const arrow     = loginMenu?.querySelector('.arrow');            // ▼ 아이콘 span

    const hasToken = !!(window.getToken && window.getToken());

    if (hasToken) {
      // 1) 상단 텍스트/동작을 LOGOUT으로 전환
      loginMenu.textContent = 'LOGOUT';
      loginMenu.href = '#';
      loginMenu.addEventListener('click', (e) => {
        e.preventDefault();
        clearToken();
        alert('You have been logged out.');
        location.href = '/';
      }, { once: true });

      // 2) 드롭다운 메뉴 제거 (로그인/회원가입/아이디찾기 숨김)
      if (submenu) submenu.remove();
      // 드롭다운 케럿/스타일 제거
      arrow?.remove();
      loginLi?.classList.remove('has-sub');

      // 3) 사람 아이콘은 마이페이지로
      personBtn?.setAttribute('href','/profile/me');
    } else {
      // 비로그인: 기본 링크 유지
      loginMenu?.setAttribute('href','/login');
      personBtn?.setAttribute('href','/login');
    }
  });
  </script>

</body>
</html>
