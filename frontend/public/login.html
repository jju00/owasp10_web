<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>LOGIN</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/frontend/public/assets/css/auth.css" />
  <meta name="csrf-token" content="__CSRF_PLACEHOLDER__">
</head>
<body class="auth">
  <main class="auth-container">
    <header class="auth-header">
      <h1>LOGIN</h1>
      <p class="sub">You need to log in to use this service.</p>
    </header>

    <!-- 일반 로그인 폼 -->
    <form id="loginForm" class="auth-form">
      <label>
        <span>ID</span>
        <input name="username" autocomplete="username"
        placeholder="Enter your username"
        required />
      </label>
      
      <label>
        <span>PW</span>
        <input type="password" name="password" autocomplete="current-password" 
        placeholder="Password (8–16 characters, including letters, numbers, and special characters)"
        required />
      </label>

      <div class="actions">
        <button type="submit" class="btn primary">Login</button>
      </div>

      <!-- Test at 2025-12-25 --> 
      <!-- executives: nagox -->

      <!-- 회원가입 | 아이디/비밀번호 찾기 -->
      <nav class="account-links" aria-label="account links">
        <a href="/signup.html">Sign Up</a>
        <span class="divider" aria-hidden="true">|</span>
        <a href="/account/recover.html">Forgot ID / Password</a>
      </nav>

      <p id="msg" class="msg" role="status" aria-live="polite"></p>
    </form>
  </main>

  <script src="/frontend/public/assets/js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('loginForm');
     
      // 로그인 전에 가려던 곳(보호 페이지) 기억한 returnTo 파라미터
      const usp = new URLSearchParams(location.search);
      const returnTo = usp.get('returnTo'); 

      bindAuthForm(form, {
        endpoint: '/login',
        onSuccess: (session) => {
          // JWT 저장
          setToken(session.token);

          // 우선순위: returnTo 있으면 거기로, 없으면 메인으로
          const target = returnTo
            ? decodeURIComponent(returnTo)
            : '/';   

          location.assign(target);
        },
        onError: (msg) => {
          alert(msg || 'Login Failed');
        }
      });
    });
  </script>

  <!-- 로그인 시 로그인했다는 거 표시 -->
  <script src="/assets/js/auth.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const loginMenu = document.getElementById('loginMenu');
    const personBtn = document.getElementById('personBtn');

    const hasToken = !!(window.getToken && window.getToken());

    if (hasToken) {
      // 메뉴: LOGOUT 으로
      if (loginMenu) {
        loginMenu.textContent = 'LOGOUT';
        loginMenu.href = '#';
        loginMenu.addEventListener('click', (e) => {
          e.preventDefault();
          clearToken();
          alert('You have been logged out.');
          location.href = '/'; 
        }, { once:true });
      }
      // 사람 아이콘: 마이페이지로
      personBtn?.setAttribute('href','/profile/me');
    } else {
      // 토큰 없으면 기본(로그인)
      loginMenu?.setAttribute('href','/frontend/public/login.html');
      personBtn?.setAttribute('href','/frontend/public/login.html');
    }
  });
  </script>

</body>
</html>
