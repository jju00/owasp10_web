<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>로그인</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/frontend/public/assets/CSS/auth.css" />
  <meta name="csrf-token" content="__CSRF_PLACEHOLDER__">
</head>
<body class="auth">
  <main class="auth-container">
    <header class="auth-header">
      <h1>로그인</h1>
      <p class="sub">서비스 이용을 위해 로그인이 필요합니다.</p>
    </header>

    <!-- 일반 로그인 폼 -->
    <form id="loginForm" class="auth-form">
      <label>
        <span>아이디</span>
        <input name="username" autocomplete="username"
        placeholder="아이디를 입력하세요"
        required />
      </label>
      
      <label>
        <span>비밀번호</span>
        <input type="password" name="password" autocomplete="current-password" 
        placeholder="비밀번호 (영문, 숫자, 특수문자 조합 8~16자리)"
        required />
      </label>

      <div class="actions">
        <button type="submit" class="btn primary">로그인</button>
      </div>

      <!-- Test at 2025-12-25 --> 
      <!-- executives: nagox -->

      <!-- 회원가입 | 아이디/비밀번호 찾기 -->
      <nav class="account-links" aria-label="account links">
        <a href="/signup.html">회원가입</a>
        <span class="divider" aria-hidden="true">|</span>
        <a href="/account/recover.html">아이디/비밀번호 찾기</a>
      </nav>

      <p id="msg" class="msg" role="status" aria-live="polite"></p>
    </form>
  </main>

  <script src="/frontend/public/assets/js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('loginForm');
     
      // 로그인 전에 가려던 곳(보호 페이지) 기억한 returnTo 파라미터
      const usp = new URLSearchParams(location.search);
      const returnTo = usp.get('returnTo'); 

      bindAuthForm(form, {
        endpoint: '/login',
        onSuccess: (session) => {
          // JWT 저장
          setToken(session.token);

          // 우선순위: returnTo 있으면 거기로, 없으면 메인으로
          const target = returnTo
            ? decodeURIComponent(returnTo)
            : '/';   

          location.assign(target);
        },
        onError: (msg) => {
          alert(msg || '로그인 실패');
        }
      });
    });
  </script>

  <!-- 로그인 시 로그인했다는 거 표시 -->
  <script src="/assets/js/auth.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const loginMenu = document.getElementById('loginMenu');
    const personBtn = document.getElementById('personBtn');

    const hasToken = !!(window.getToken && window.getToken());

    if (hasToken) {
      // 메뉴: LOGOUT 으로
      if (loginMenu) {
        loginMenu.textContent = 'LOGOUT';
        loginMenu.href = '#';
        loginMenu.addEventListener('click', (e) => {
          e.preventDefault();
          clearToken();
          alert('로그아웃되었습니다.');
          location.href = '/'; 
        }, { once:true });
      }
      // 사람 아이콘: 마이페이지로
      personBtn?.setAttribute('href','/profile/me');
    } else {
      // 토큰 없으면 기본(로그인)
      loginMenu?.setAttribute('href','/frontend/public/login.html');
      personBtn?.setAttribute('href','/frontend/public/login.html');
    }
  });
  </script>

</body>
</html>
